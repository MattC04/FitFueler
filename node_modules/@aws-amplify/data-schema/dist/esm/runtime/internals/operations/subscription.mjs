import { map } from 'rxjs';
import { generateGraphQLDocument, buildGraphQLVariables, authModeParams, getCustomHeaders, initializeModel } from '../APIClient.mjs';

// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: Apache-2.0
function subscriptionFactory(client, modelIntrospection, model, operation, getInternals) {
    const { name } = model;
    const subscription = (args) => {
        const query = generateGraphQLDocument(modelIntrospection, name, operation, args);
        const variables = buildGraphQLVariables(model, operation, args, modelIntrospection);
        const auth = authModeParams(client, getInternals, args);
        const headers = getCustomHeaders(client, getInternals, args?.headers);
        const observable = client.graphql({
            ...auth,
            query,
            variables,
        }, headers);
        return observable.pipe(map((value) => {
            const [key] = Object.keys(value.data);
            // Will need flattening here if/when custom selection set support is added:
            const data = value.data[key];
            const [initialized] = initializeModel(client, name, [data], modelIntrospection, auth.authMode, auth.authToken);
            return initialized;
        }));
    };
    return subscription;
}

export { subscriptionFactory };
//# sourceMappingURL=subscription.mjs.map
