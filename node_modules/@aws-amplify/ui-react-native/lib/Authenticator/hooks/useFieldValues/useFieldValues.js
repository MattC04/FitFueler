"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const react_1 = require("react");
const utils_1 = require("aws-amplify/utils");
const utils_2 = require("./utils");
const logger = new utils_1.ConsoleLogger('Authenticator');
function useFieldValues({ componentName, fields = [], handleBlur, handleChange, handleSubmit, validationErrors, }) {
    const [values, setValues] = (0, react_1.useState)({});
    const [touched, setTouched] = (0, react_1.useState)({});
    const [fieldValidationErrors, setFieldValidationErrors] = (0, react_1.useState)({});
    const isRadioFieldComponent = componentName === 'VerifyUser';
    const sanitizedFields = (0, react_1.useMemo)(() => {
        if (!Array.isArray(fields)) {
            logger.warn(`Invalid fields type of ${typeof fields} passed to ${componentName}. fields must be of type array.`);
            return [];
        }
        if (isRadioFieldComponent) {
            return (0, utils_2.getSanitizedRadioFields)(fields, componentName);
        }
        return (0, utils_2.getSanitizedTextFields)(fields, componentName);
    }, [componentName, fields, isRadioFieldComponent]);
    const fieldsWithHandlers = sanitizedFields.map((field) => {
        if ((0, utils_2.isRadioFieldOptions)(field)) {
            const onChange = (value) => {
                // call `onChange` passed as radio `field` option
                field.onChange?.(value);
                // set `name` as value of 'unverifiedAttr'
                setValues({ unverifiedAttr: value });
            };
            return { ...field, onChange };
        }
        const { name, label, labelHidden, ...rest } = field;
        const onBlur = (event) => {
            setTouched({ ...touched, [name]: true });
            // call `onBlur` passed as text `field` option
            field.onBlur?.(event);
            // call machine blur handler
            handleBlur({ name, value: values[name] });
            setFieldValidationErrors({
                ...fieldValidationErrors,
                [name]: (0, utils_2.runFieldValidation)(field, values[name], validationErrors),
            });
        };
        const onChangeText = (value) => {
            // call `onChangeText` passed as text `field` option
            field.onChangeText?.(value);
            // call machine change handler
            handleChange({ name, value });
            if (touched[name]) {
                setFieldValidationErrors({
                    ...fieldValidationErrors,
                    [name]: (0, utils_2.runFieldValidation)(field, value, validationErrors),
                });
            }
            setValues({ ...values, [name]: value });
        };
        return {
            ...rest,
            label: labelHidden ? undefined : label,
            onBlur,
            onChangeText,
            name,
            value: values[name],
        };
    });
    const disableFormSubmit = isRadioFieldComponent
        ? !values.unverifiedAttr
        : fieldsWithHandlers.some(({ required, value }) => {
            if (!required) {
                return false;
            }
            if (value) {
                return false;
            }
            return true;
        });
    const handleFormSubmit = () => {
        const submitValue = isRadioFieldComponent
            ? values
            : fieldsWithHandlers.reduce((acc, { name, value = '', type }) => {
                /*
                      For phone numbers pass the first 3 charactes from value as dialCode until we support a dialCode picker
                  */
                return type === 'phone'
                    ? {
                        ...acc,
                        country_code: value?.substring(0, 3),
                        [name]: value?.substring(3, value.length),
                    }
                    : { ...acc, [name]: value };
            }, {});
        handleSubmit?.(submitValue);
    };
    return {
        fields: fieldsWithHandlers,
        disableFormSubmit,
        fieldValidationErrors: { ...fieldValidationErrors, ...validationErrors },
        handleFormSubmit,
    };
}
exports.default = useFieldValues;
